<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RayVita-Synapse | Advanced Neural Health Analytics Platform</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-cyan: #00ffff;
            --primary-blue: #0080ff;
            --primary-purple: #8000ff;
            --accent-pink: #ff0080;
            --accent-green: #00ff88;
            --accent-orange: #ff8800;
            --accent-gold: #ffd700;
            --dark-bg: #0a0a0f;
            --card-bg: rgba(255, 255, 255, 0.03);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --border-glow: rgba(0, 255, 255, 0.3);
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-muted: #808080;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(ellipse at top, #1a1a2e 0%, #16213e 25%, #0f1419 50%, var(--dark-bg) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Enhanced Background Effects */
        .neural-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -3;
        }

        .neural-nodes {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(3px 3px at 20px 30px, var(--primary-cyan), transparent),
                radial-gradient(2px 2px at 40px 70px, var(--primary-blue), transparent),
                radial-gradient(2px 2px at 90px 40px, var(--accent-pink), transparent),
                radial-gradient(1px 1px at 130px 80px, var(--primary-purple), transparent),
                radial-gradient(2px 2px at 160px 30px, var(--accent-green), transparent);
            background-size: 200px 200px, 150px 150px, 180px 180px, 120px 120px, 140px 140px;
            animation: neuralFloat 20s linear infinite;
            opacity: 0.4;
        }

        @keyframes neuralFloat {
            0% { transform: translate(0, 0) rotate(0deg); }
            100% { transform: translate(-200px, -200px) rotate(360deg); }
        }

        .grid-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                linear-gradient(rgba(0, 255, 255, 0.08) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.08) 1px, transparent 1px);
            background-size: 60px 60px;
            z-index: -2;
            animation: gridPulse 8s ease-in-out infinite;
        }

        @keyframes gridPulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.7; }
        }

        .constellation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.2;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: var(--primary-cyan);
            border-radius: 50%;
            animation: twinkle 3s ease-in-out infinite alternate;
        }

        @keyframes twinkle {
            0% { opacity: 0.3; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.5); }
        }

        /* App Container */
        .app-container {
            position: relative;
            min-height: 100vh;
        }

        /* Enhanced Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(20px);
            background: rgba(0, 0, 0, 0.8);
        }

        .login-container {
            background: var(--glass-bg);
            border: 2px solid var(--border-glow);
            border-radius: 24px;
            padding: 50px;
            backdrop-filter: blur(30px);
            box-shadow: 0 25px 60px rgba(0, 255, 255, 0.15);
            width: 100%;
            max-width: 480px;
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, var(--primary-cyan), var(--primary-blue), var(--primary-purple), var(--accent-pink));
            border-radius: 24px;
            z-index: -1;
            animation: borderGlow 4s ease-in-out infinite;
        }

        @keyframes borderGlow {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .logo-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(45deg, var(--primary-cyan), var(--primary-blue));
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 25px;
            font-family: 'Orbitron', monospace;
            font-size: 48px;
            font-weight: 900;
            color: #000;
            animation: logoSpin 12s linear infinite;
            box-shadow: 0 15px 40px rgba(0, 255, 255, 0.4);
        }

        .app-title {
            font-family: 'Orbitron', monospace;
            font-size: 32px;
            font-weight: 900;
            letter-spacing: 3px;
            background: linear-gradient(45deg, var(--primary-cyan), var(--primary-blue));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
        }

        .app-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
            letter-spacing: 1px;
            line-height: 1.4;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            color: var(--primary-cyan);
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 18px 24px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 15px;
            color: var(--text-primary);
            font-size: 16px;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary-cyan);
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.4);
            background: rgba(0, 255, 255, 0.05);
            transform: translateY(-2px);
        }

        .auth-button, .action-button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(45deg, var(--primary-cyan), var(--primary-blue));
            border: none;
            border-radius: 15px;
            color: #000;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .auth-button:hover, .action-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0, 255, 255, 0.5);
        }

        .auth-toggle {
            text-align: center;
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 20px;
        }

        .auth-toggle a {
            color: var(--primary-cyan);
            text-decoration: none;
            cursor: pointer;
            font-weight: 600;
        }

        /* Enhanced Main App Layout */
        .main-app {
            display: none;
        }

        .app-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(25px);
            border-bottom: 2px solid var(--border-glow);
            padding: 20px 40px;
            box-shadow: 0 8px 32px rgba(0, 255, 255, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1800px;
            margin: 0 auto;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, var(--primary-cyan), var(--primary-blue));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron', monospace;
            font-weight: 900;
            color: #000;
            font-size: 24px;
            animation: logoSpin 15s linear infinite;
            box-shadow: 0 8px 25px rgba(0, 255, 255, 0.3);
        }

        .header-title {
            font-family: 'Orbitron', monospace;
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-cyan);
            letter-spacing: 2px;
        }

        .header-nav {
            display: flex;
            gap: 8px;
            background: rgba(0, 0, 0, 0.3);
            padding: 6px;
            border-radius: 15px;
            border: 1px solid rgba(0, 255, 255, 0.2);
            flex-wrap: wrap;
        }

        .nav-item {
            padding: 10px 18px;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
            border: 1px solid transparent;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .nav-item:hover {
            background: var(--glass-bg);
            border-color: var(--border-glow);
            transform: translateY(-2px);
        }

        .nav-item.active {
            background: linear-gradient(45deg, var(--primary-cyan), var(--primary-blue));
            color: #000;
            font-weight: 700;
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.3);
        }

        .header-user {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            background: linear-gradient(45deg, var(--accent-pink), var(--primary-purple));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #fff;
            font-size: 18px;
            box-shadow: 0 5px 15px rgba(255, 0, 128, 0.3);
        }

        .logout-btn {
            padding: 10px 20px;
            background: rgba(255, 0, 128, 0.2);
            border: 1px solid var(--accent-pink);
            border-radius: 10px;
            color: var(--accent-pink);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
        }

        .logout-btn:hover {
            background: var(--accent-pink);
            color: #000;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 0, 128, 0.4);
        }

        /* Enhanced Content Area */
        .content-area {
            padding: 40px;
            max-width: 1800px;
            margin: 0 auto;
        }

        /* Panel Styles */
        .panel {
            display: none;
            animation: panelSlide 0.5s ease-out;
        }

        .panel.active {
            display: block;
        }

        @keyframes panelSlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .panel-header {
            margin-bottom: 40px;
            text-align: center;
        }

        .panel-title {
            font-family: 'Orbitron', monospace;
            font-size: 42px;
            font-weight: 700;
            background: linear-gradient(45deg, var(--primary-cyan), var(--primary-blue), var(--primary-purple));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
            letter-spacing: 2px;
        }

        .panel-subtitle {
            color: var(--text-secondary);
            font-size: 18px;
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Enhanced Card Grid */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .card-grid.dense {
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }

        .card-grid.wide {
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        }

        /* Enhanced Neural Card */
        .neural-card {
            background: var(--card-bg);
            border: 1px solid var(--border-glow);
            border-radius: 25px;
            padding: 35px;
            backdrop-filter: blur(25px);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 255, 255, 0.05);
        }

        .neural-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--primary-cyan), transparent);
            animation: cardScan 5s linear infinite;
        }

        @keyframes cardScan {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .neural-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 25px 60px rgba(0, 255, 255, 0.2);
            border-color: var(--primary-cyan);
        }

        .neural-card.featured {
            border: 2px solid var(--accent-gold);
            box-shadow: 0 15px 40px rgba(255, 215, 0, 0.1);
        }

        .neural-card.featured::before {
            background: linear-gradient(90deg, transparent, var(--accent-gold), transparent);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .card-title {
            font-family: 'Orbitron', monospace;
            font-size: 20px;
            font-weight: 600;
            color: var(--primary-cyan);
            letter-spacing: 1px;
        }

        .card-subtitle {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 5px;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, var(--accent-pink), var(--primary-purple));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            animation: iconFloat 4s ease-in-out infinite;
        }

        @keyframes iconFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        /* Enhanced Metrics */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 20px;
        }

        .metric-item {
            text-align: center;
            padding: 25px;
            background: rgba(0, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 15px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .metric-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent, rgba(0, 255, 255, 0.1), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .metric-item:hover::before {
            transform: translateX(100%);
        }

        .metric-item:hover {
            background: rgba(0, 255, 255, 0.1);
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 255, 255, 0.2);
        }

        .metric-value {
            font-family: 'Orbitron', monospace;
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-cyan);
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        .metric-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .metric-trend {
            margin-top: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .trend-up { color: var(--accent-green); }
        .trend-down { color: var(--accent-pink); }
        .trend-stable { color: var(--accent-orange); }

        /* Enhanced Chart Container */
        .chart-container {
            position: relative;
            height: 320px;
            margin-top: 25px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            border: 1px solid rgba(0, 255, 255, 0.1);
        }

        .chart-container.large {
            height: 450px;
        }

        .chart-container.xlarge {
            height: 500px;
        }

        /* AI Chat Interface */
        .ai-chat-container {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            height: 600px;
        }

        .chat-interface {
            display: flex;
            flex-direction: column;
            background: var(--card-bg);
            border: 1px solid var(--border-glow);
            border-radius: 20px;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(45deg, var(--primary-purple), var(--accent-pink));
            color: #fff;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 15px 20px;
            border-radius: 18px;
            position: relative;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            background: linear-gradient(45deg, var(--primary-cyan), var(--primary-blue));
            color: #000;
            align-self: flex-end;
            margin-left: auto;
        }

        .message.ai {
            background: var(--glass-bg);
            border: 1px solid rgba(128, 0, 255, 0.3);
            color: var(--text-primary);
            align-self: flex-start;
        }

        .chat-input-area {
            padding: 20px;
            border-top: 1px solid rgba(0, 255, 255, 0.2);
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            min-height: 44px;
            max-height: 120px;
            padding: 12px 18px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 22px;
            color: var(--text-primary);
            resize: none;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            line-height: 1.4;
        }

        .chat-send-btn {
            width: 44px;
            height: 44px;
            background: linear-gradient(45deg, var(--primary-cyan), var(--primary-blue));
            border: none;
            border-radius: 50%;
            color: #000;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .chat-send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(0, 255, 255, 0.4);
        }

        .record-selector {
            background: var(--card-bg);
            border: 1px solid var(--border-glow);
            border-radius: 20px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .record-item-chat {
            padding: 15px;
            background: rgba(0, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .record-item-chat:hover {
            background: rgba(0, 255, 255, 0.1);
            border-color: var(--primary-cyan);
            transform: translateY(-2px);
        }

        .record-item-chat.selected {
            background: rgba(0, 255, 255, 0.2);
            border-color: var(--primary-cyan);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.3);
        }

        /* Advanced rPPG Record Viewer */
        .record-viewer-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .record-viewer-content {
            background: var(--card-bg);
            border: 2px solid var(--border-glow);
            border-radius: 25px;
            width: 100%;
            max-width: 1400px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 40px;
            position: relative;
        }

        .record-viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0, 255, 255, 0.2);
        }

        .close-viewer {
            width: 40px;
            height: 40px;
            background: rgba(255, 0, 128, 0.2);
            border: 1px solid var(--accent-pink);
            border-radius: 50%;
            color: var(--accent-pink);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .close-viewer:hover {
            background: var(--accent-pink);
            color: #000;
        }

        .waveform-container {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
            height: 300px;
        }

        .waveform-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .waveform-btn {
            padding: 8px 16px;
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 20px;
            color: var(--primary-cyan);
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .waveform-btn:hover, .waveform-btn.active {
            background: var(--primary-cyan);
            color: #000;
        }

        /* Enhanced Social Styles */
        .social-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        .social-feed-section {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .post-composer {
            background: var(--card-bg);
            border: 1px solid var(--border-glow);
            border-radius: 20px;
            padding: 25px;
        }

        .composer-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .composer-tools {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .composer-tool {
            padding: 8px 15px;
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 15px;
            color: var(--primary-cyan);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .composer-tool:hover {
            background: rgba(0, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .social-sidebar {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .trending-section {
            background: var(--card-bg);
            border: 1px solid var(--border-glow);
            border-radius: 20px;
            padding: 25px;
        }

        .trending-item {
            padding: 12px 0;
            border-bottom: 1px solid rgba(0, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .trending-item:hover {
            color: var(--primary-cyan);
            transform: translateX(5px);
        }

        .trending-item:last-child {
            border-bottom: none;
        }

        .post-item {
            background: var(--card-bg);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 20px;
            padding: 25px;
            transition: all 0.3s ease;
        }

        .post-item:hover {
            border-color: var(--primary-cyan);
            box-shadow: 0 10px 30px rgba(0, 255, 255, 0.1);
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .post-avatar {
            width: 45px;
            height: 45px;
            background: linear-gradient(45deg, var(--accent-green), var(--primary-blue));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #fff;
        }

        .post-meta {
            flex: 1;
        }

        .post-author {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 3px;
        }

        .post-time {
            font-size: 12px;
            color: var(--text-muted);
        }

        .post-content {
            margin: 15px 0;
            line-height: 1.6;
        }

        .post-actions {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 255, 255, 0.1);
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border: 1px solid;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-like {
            border-color: var(--accent-pink);
            color: var(--accent-pink);
        }

        .btn-like:hover, .btn-like.liked {
            background: var(--accent-pink);
            color: #000;
        }

        .btn-comment {
            border-color: var(--primary-blue);
            color: var(--primary-blue);
        }

        .btn-comment:hover {
            background: var(--primary-blue);
            color: #000;
        }

        .btn-share {
            border-color: var(--accent-green);
            color: var(--accent-green);
        }

        .btn-share:hover {
            background: var(--accent-green);
            color: #000;
        }

        /* rPPG Records Enhanced Display */
        .record-item {
            background: var(--card-bg);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .record-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-green), transparent);
            animation: recordScan 4s linear infinite;
        }

        @keyframes recordScan {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .record-item:hover {
            border-color: var(--primary-cyan);
            box-shadow: 0 10px 30px rgba(0, 255, 255, 0.1);
            transform: translateY(-3px);
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .record-id {
            font-family: 'Orbitron', monospace;
            color: var(--primary-cyan);
            font-weight: 600;
            font-size: 16px;
        }

        .record-time {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .record-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .record-metric {
            text-align: center;
            padding: 15px;
            background: rgba(0, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 255, 0.1);
        }

        .record-metric-value {
            font-family: 'Orbitron', monospace;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-cyan);
            margin-bottom: 5px;
        }

        .record-metric-label {
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .record-quality {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .quality-bar {
            flex: 1;
            height: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            overflow: hidden;
        }

        .quality-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-pink), var(--accent-orange), var(--accent-green));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .quality-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* Download Section */
        .download-section {
            text-align: center;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 136, 0, 0.1));
            border: 2px solid var(--accent-gold);
            border-radius: 25px;
            padding: 50px;
            margin: 40px 0;
        }

        .download-title {
            font-family: 'Orbitron', monospace;
            font-size: 36px;
            color: var(--accent-gold);
            margin-bottom: 20px;
            font-weight: 700;
        }

        .download-subtitle {
            color: var(--text-secondary);
            font-size: 18px;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .download-btn {
            display: inline-flex;
            align-items: center;
            gap: 15px;
            padding: 20px 40px;
            background: linear-gradient(45deg, var(--accent-gold), var(--accent-orange));
            border: none;
            border-radius: 15px;
            color: #000;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            margin: 10px;
        }

        .download-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(255, 215, 0, 0.4);
        }

        .download-icon {
            font-size: 24px;
        }

        /* Contact & Map Styles */
        .contact-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-top: 30px;
        }

        .contact-info {
            background: var(--card-bg);
            border: 1px solid var(--border-glow);
            border-radius: 20px;
            padding: 30px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .contact-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, var(--primary-cyan), var(--primary-blue));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: 700;
        }

        .map-container {
            background: var(--card-bg);
            border: 1px solid var(--border-glow);
            border-radius: 20px;
            padding: 20px;
            height: 400px;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: 15px;
        }

        /* Educational Content Styles */
        .education-section {
            background: linear-gradient(135deg, rgba(0, 128, 255, 0.05), rgba(0, 255, 255, 0.05));
            border: 1px solid var(--primary-blue);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .education-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
        }

        .education-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, var(--primary-blue), var(--primary-cyan));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .education-title {
            font-family: 'Orbitron', monospace;
            font-size: 24px;
            color: var(--primary-blue);
            font-weight: 600;
        }

        .education-content {
            line-height: 1.8;
            color: var(--text-primary);
        }

        .education-feature {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border-left: 3px solid var(--primary-blue);
        }

        .feature-icon {
            color: var(--primary-cyan);
            font-size: 18px;
            margin-top: 2px;
        }

        /* Utility Classes */
        .loading {
            text-align: center;
            padding: 60px;
            color: var(--primary-cyan);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(0, 255, 255, 0.1);
            border-top: 4px solid var(--primary-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(255, 0, 128, 0.1);
            border: 1px solid var(--accent-pink);
            border-radius: 10px;
            padding: 20px;
            color: var(--accent-pink);
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .success-message {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid var(--accent-green);
            border-radius: 10px;
            padding: 20px;
            color: var(--accent-green);
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .card-grid {
                grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            }

            .contact-grid {
                grid-template-columns: 1fr;
            }

            .ai-chat-container {
                grid-template-columns: 1fr;
                height: auto;
            }

            .social-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .app-header {
                padding: 20px 25px;
            }

            .header-content {
                flex-direction: column;
                gap: 20px;
            }

            .header-nav {
                gap: 5px;
                padding: 5px;
            }

            .nav-item {
                padding: 8px 12px;
                font-size: 11px;
            }

            .content-area {
                padding: 25px;
            }

            .card-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .login-container {
                padding: 30px 25px;
                margin: 20px;
            }

            .panel-title {
                font-size: 32px;
            }

            .record-viewer-content {
                padding: 20px;
                margin: 20px;
            }
        }

        @keyframes logoSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Stars for constellation effect */
        .star:nth-child(1) { top: 10%; left: 20%; animation-delay: 0s; }
        .star:nth-child(2) { top: 20%; left: 80%; animation-delay: 1s; }
        .star:nth-child(3) { top: 60%; left: 30%; animation-delay: 2s; }
        .star:nth-child(4) { top: 80%; left: 70%; animation-delay: 0.5s; }
        .star:nth-child(5) { top: 40%; left: 60%; animation-delay: 1.5s; }
    </style>
</head>
<body>
    <div class="neural-background">
        <div class="neural-nodes"></div>
    </div>
    <div class="grid-overlay"></div>
    <div class="constellation">
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
    </div>

    <div class="app-container">
        <!-- Login Screen -->
        <div class="login-screen" id="loginScreen">
            <div class="login-container">
                <div class="logo-section">
                    <div class="logo-icon">R</div>
                    <div class="app-title">RayVita-Synapse</div>
                    <div class="app-subtitle">先进神经健康分析平台<br>无接触健康监测与AI洞察</div>
                </div>

                <form id="authForm">
                    <div class="form-group">
                        <label class="form-label">邮箱地址</label>
                        <input type="email" class="form-input" id="email" required placeholder="your.email@domain.com">
                    </div>

                    <div class="form-group">
                        <label class="form-label">密码</label>
                        <input type="password" class="form-input" id="password" required placeholder="输入您的密码">
                    </div>

                    <div class="form-group" id="nicknameGroup" style="display: none;">
                        <label class="form-label">显示名称</label>
                        <input type="text" class="form-input" id="nickname" placeholder="您的显示名称">
                    </div>

                    <button type="submit" class="auth-button" id="authButton">
                        接入神经网络
                    </button>

                    <div class="auth-toggle">
                        RayVita新用户? <a href="#" id="toggleAuth">创建神经档案</a>
                    </div>
                </form>

                <div id="authMessage"></div>
            </div>
        </div>

        <!-- Main Application -->
        <div class="main-app" id="mainApp">
            <!-- Enhanced Header -->
            <header class="app-header">
                <div class="header-content">
                    <div class="header-logo">
                        <div class="header-logo-icon">R</div>
                        <div>
                            <div class="header-title">RayVita-Synapse</div>
                            <div style="font-size: 12px; color: var(--text-secondary); letter-spacing: 1px;">神经健康分析</div>
                        </div>
                    </div>

                    <nav class="header-nav">
                        <div class="nav-item active" data-panel="dashboard">仪表板</div>
                        <div class="nav-item" data-panel="records">rPPG记录</div>
                        <div class="nav-item" data-panel="ai-chat">AI对话</div>
                        <div class="nav-item" data-panel="analysis">AI分析</div>
                        <div class="nav-item" data-panel="social">社交动态</div>
                        <div class="nav-item" data-panel="about">关于rPPG</div>
                        <div class="nav-item" data-panel="download">获取应用</div>
                        <div class="nav-item" data-panel="contact">联系我们</div>
                    </nav>

                    <div class="header-user">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <div>
                            <div id="userName" style="font-weight: 600;">用户</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">神经ID: <span id="userId">--</span></div>
                        </div>
                        <button class="logout-btn" onclick="logout()">退出</button>
                    </div>
                </div>
            </header>

            <!-- Enhanced Content Area -->
            <main class="content-area">
                <!-- Dashboard Panel -->
                <div class="panel active" id="dashboard">
                    <div class="panel-header">
                        <h1 class="panel-title">神经健康仪表板</h1>
                        <p class="panel-subtitle">基于先进rPPG技术的实时生物测量分析及AI驱动的健康洞察</p>
                    </div>

                    <div class="card-grid">
                        <!-- Enhanced Vital Signs Card -->
                        <div class="neural-card featured">
                            <div class="card-header">
                                <div>
                                    <h3 class="card-title">生命体征矩阵</h3>
                                    <div class="card-subtitle">实时生物测量监控</div>
                                </div>
                                <div class="card-icon">💗</div>
                            </div>
                            <div class="metrics-grid" id="vitalMetrics">
                                <!-- Metrics will be populated here -->
                            </div>
                        </div>

                        <!-- Heart Rate Chart -->
                        <div class="neural-card">
                            <div class="card-header">
                                <div>
                                    <h3 class="card-title">心律节律分析</h3>
                                    <div class="card-subtitle">心率变异性趋势</div>
                                </div>
                                <div class="card-icon">📈</div>
                            </div>
                            <div class="chart-container">
                                <canvas id="heartRateChart"></canvas>
                            </div>
                        </div>

                        <!-- HRV Analysis -->
                        <div class="neural-card">
                            <div class="card-header">
                                <div>
                                    <h3 class="card-title">HRV神经模式</h3>
                                    <div class="card-subtitle">自主神经系统分析</div>
                                </div>
                                <div class="card-icon">🧠</div>
                            </div>
                            <div class="chart-container">
                                <canvas id="hrvChart"></canvas>
                            </div>
                        </div>

                        <!-- SpO2 Monitoring -->
                        <div class="neural-card">
                            <div class="card-header">
                                <div>
                                    <h3 class="card-title">血氧饱和度</h3>
                                    <div class="card-subtitle">血液氧合水平</div>
                                </div>
                                <div class="card-icon">🫁</div>
                            </div>
                            <div class="chart-container">
                                <canvas id="spo2Chart"></canvas>
                            </div>
                        </div>

                        <!-- Signal Quality Assessment -->
                        <div class="neural-card">
                            <div class="card-header">
                                <div>
                                    <h3 class="card-title">信号质量矩阵</h3>
                                    <div class="card-subtitle">rPPG信号分析指标</div>
                                </div>
                                <div class="card-icon">📡</div>
                            </div>
                            <div class="chart-container">
                                <canvas id="qualityChart"></canvas>
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div class="neural-card">
                            <div class="card-header">
                                <div>
                                    <h3 class="card-title">最近神经活动</h3>
                                    <div class="card-subtitle">最新健康测量记录</div>
                                </div>
                                <div class="card-icon">⚡</div>
                            </div>
                            <div id="recentActivity">
                                <!-- Recent measurements will be populated here -->
                            </div>
                        </div>
                    </div>

                    <div id="loadingDashboard" class="loading" style="display: none;">
                        <div class="spinner"></div>
                        <div>正在同步神经数据流...</div>
                    </div>
                </div>

                <!-- Enhanced rPPG Records Panel -->
                <div class="panel" id="records">
                    <div class="panel-header">
                        <h1 class="panel-title">rPPG检测记录</h1>
                        <p class="panel-subtitle">全面分析您的光电容积脉搏波测量记录和信号质量评估</p>
                    </div>

                    <div class="neural-card">
                        <div class="card-header">
                            <div>
                                <h3 class="card-title">测量历史记录</h3>
                                <div class="card-subtitle">详细rPPG会话记录</div>
                            </div>
                            <div class="card-icon">📊</div>
                        </div>

                        <div class="metrics-grid" style="margin-bottom: 30px;">
                            <div class="metric-item">
                                <div class="metric-value" id="totalSessions">--</div>
                                <div class="metric-label">总会话数</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value" id="avgHeartRate">--</div>
                                <div class="metric-label">平均心率</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value" id="avgConfidence">--</div>
                                <div class="metric-label">平均置信度</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value" id="lastMeasurement">--</div>
                                <div class="metric-label">最近测量</div>
                            </div>
                        </div>

                        <div id="recordsList">
                            <!-- Records will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- AI Chat Panel -->
                <div class="panel" id="ai-chat">
                    <div class="panel-header">
                        <h1 class="panel-title">AI健康顾问</h1>
                        <p class="panel-subtitle">与AI进行智能对话，获取个性化健康建议和深度数据分析</p>
                    </div>

                    <div class="ai-chat-container">
                        <div class="chat-interface">
                            <div class="chat-header">
                                <div style="font-size: 24px;">🤖</div>
                                <div>
                                    <div style="font-weight: 700; font-size: 18px;">RayVita AI 健康顾问</div>
                                    <div style="font-size: 14px; opacity: 0.8;">在线 • 由DeepSeek驱动</div>
                                </div>
                            </div>

                            <div class="chat-messages" id="chatMessages">
                                <div class="message ai">
                                    <div>👋 您好！我是RayVita AI健康顾问。我可以帮助您：</div>
                                    <div style="margin-top: 10px;">
                                        • 💓 分析您的心率和HRV数据<br>
                                        • 📊 解读特定测量记录<br>
                                        • 💡 提供个性化健康建议<br>
                                        • 🏥 评估您的心血管健康状态
                                    </div>
                                    <div style="margin-top: 10px; color: var(--accent-green);">请选择右侧的记录进行深度分析，或直接向我提问！</div>
                                </div>
                            </div>

                            <div class="chat-input-area">
                                <textarea
                                    class="chat-input"
                                    id="chatInput"
                                    placeholder="请输入您的健康问题或选择记录进行分析..."
                                    rows="1"
                                ></textarea>
                                <button class="chat-send-btn" onclick="sendMessage()">
                                    ➤
                                </button>
                            </div>
                        </div>

                        <div class="record-selector">
                            <h4 style="color: var(--primary-cyan); margin-bottom: 15px; font-family: 'Orbitron', monospace;">选择记录分析</h4>
                            <div id="chatRecordsList">
                                <!-- Records for chat selection will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced AI Analysis Panel -->
                <div class="panel" id="analysis">
                    <div class="panel-header">
                        <h1 class="panel-title">AI神经分析</h1>
                        <p class="panel-subtitle">基于DeepSeek AI和机器学习算法的高级健康洞察</p>
                    </div>

                    <div class="neural-card">
                        <div class="card-header">
                            <div>
                                <h3 class="card-title">健康分析引擎</h3>
                                <div class="card-subtitle">AI驱动的生物测量洞察</div>
                            </div>
                            <div class="card-icon">🤖</div>
                        </div>

                        <button class="auth-button" onclick="performAIAnalysis()" style="margin-bottom: 30px;">
                            🧠 生成高级AI健康分析
                        </button>

                        <div id="aiAnalysisContent">
                            <div style="border: 2px dashed rgba(0, 255, 255, 0.3); text-align: center; padding: 40px; border-radius: 20px; background: rgba(0, 255, 255, 0.02);">
                                <div style="font-size: 48px; margin-bottom: 20px;">🔬</div>
                                <h4 style="color: var(--primary-cyan); margin-bottom: 15px; font-family: 'Orbitron', monospace;">准备神经分析</h4>
                                <p style="color: var(--text-secondary);">点击上方按钮生成基于您的rPPG测量、心率变异性模式和生理指标的综合AI洞察。</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Social Panel -->
                <div class="panel" id="social">
                    <div class="panel-header">
                        <h1 class="panel-title">健康社交网络</h1>
                        <p class="panel-subtitle">与健康社区连接，分享健康洞察，在您的健康之旅中保持动力</p>
                    </div>

                    <div class="social-container">
                        <div class="social-feed-section">
                            <!-- Post Composer -->
                            <div class="post-composer">
                                <div class="composer-header">
                                    <div class="post-avatar" id="composerAvatar">U</div>
                                    <div style="flex: 1;">
                                        <textarea
                                            class="form-textarea"
                                            id="postText"
                                            placeholder="分享您的健康心得或今日感受..."
                                            rows="3"
                                        ></textarea>
                                    </div>
                                </div>

                                <div class="composer-tools">
                                    <div class="composer-tool">
                                        <span>📊</span>
                                        <span>健康数据</span>
                                    </div>
                                    <div class="composer-tool">
                                        <span>📷</span>
                                        <span>照片</span>
                                    </div>
                                    <div class="composer-tool">
                                        <span>📍</span>
                                        <span>位置</span>
                                    </div>
                                    <div class="composer-tool">
                                        <span>😊</span>
                                        <span>心情</span>
                                    </div>
                                </div>

                                <button class="action-button" onclick="createPost()">
                                    📝 发布健康动态
                                </button>
                            </div>

                            <!-- Social Feed -->
                            <div id="socialFeed">
                                <!-- Posts will be populated here -->
                            </div>
                        </div>

                        <div class="social-sidebar">
                            <!-- Trending Topics -->
                            <div class="trending-section">
                                <h4 style="color: var(--primary-cyan); margin-bottom: 20px; font-family: 'Orbitron', monospace;">🔥 健康热门话题</h4>
                                <div class="trending-item"># 心率健康</div>
                                <div class="trending-item"># rPPG技术</div>
                                <div class="trending-item"># 健康生活方式</div>
                                <div class="trending-item"># 压力管理</div>
                                <div class="trending-item"># 运动健康</div>
                                <div class="trending-item"># 睡眠质量</div>
                            </div>

                            <!-- Personal Stats -->
                            <div class="trending-section">
                                <h4 style="color: var(--primary-cyan); margin-bottom: 20px; font-family: 'Orbitron', monospace;">📈 我的健康统计</h4>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                    <span>今日测量:</span>
                                    <span style="color: var(--accent-green);" id="todayMeasurements">0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                    <span>本周平均心率:</span>
                                    <span style="color: var(--primary-cyan);" id="weeklyAvgHR">--</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                    <span>健康评分:</span>
                                    <span style="color: var(--accent-gold);" id="healthScore">--</span>
                                </div>
                            </div>

                            <!-- Friends Network -->
                            <div class="trending-section">
                                <h4 style="color: var(--primary-cyan); margin-bottom: 20px; font-family: 'Orbitron', monospace;">👥 健康网络</h4>
                                <div id="friendsNetwork">
                                    <!-- Friends will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- About rPPG Panel -->
                <div class="panel" id="about">
                    <div class="panel-header">
                        <h1 class="panel-title">关于rPPG技术</h1>
                        <p class="panel-subtitle">了解远程光电容积脉搏波技术及其在无接触健康监测中的革命性影响</p>
                    </div>

                    <div class="education-section">
                        <div class="education-header">
                            <div class="education-icon">🔬</div>
                            <div class="education-title">什么是rPPG？</div>
                        </div>
                        <div class="education-content">
                            <p><strong>远程光电容积脉搏波技术(rPPG)</strong>是一项突破性技术，能够仅使用摄像头进行无接触的生理信号测量。通过分析血液循环引起的人体皮肤微妙颜色变化，rPPG可以准确检测心率、心率变异性，甚至血氧饱和度水平。</p>

                            <div class="education-feature">
                                <div class="feature-icon">📱</div>
                                <div>
                                    <strong>基于摄像头的检测</strong><br>
                                    使用您设备的摄像头捕获面部皮肤中与心跳对应的微观颜色变化。
                                </div>
                            </div>

                            <div class="education-feature">
                                <div class="feature-icon">⚡</div>
                                <div>
                                    <strong>实时处理</strong><br>
                                    先进算法实时处理视频帧，以医疗级精度提取心血管信号。
                                </div>
                            </div>

                            <div class="education-feature">
                                <div class="feature-icon">🧠</div>
                                <div>
                                    <strong>AI增强分析</strong><br>
                                    机器学习模型过滤噪声并增强信号质量，实现可靠的健康测量。
                                </div>
                            </div>

                            <div class="education-feature">
                                <div class="feature-icon">🌐</div>
                                <div>
                                    <strong>无接触便捷</strong><br>
                                    无需可穿戴设备或传感器 - 只需将摄像头对准即可获得即时健康洞察。
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="education-section">
                        <div class="education-header">
                            <div class="education-icon">📱</div>
                            <div class="education-title">RayVita应用概述</div>
                        </div>
                        <div class="education-content">
                            <p><strong>RayVita</strong>是一款融合健康科技与社交互动的智能健康App。其核心功能包括基于rPPG技术的无接触心率检测和健康社交系统，提升健康管理的趣味性与持续性。</p>

                            <div class="education-feature">
                                <div class="feature-icon">❤️</div>
                                <div>
                                    <strong>无接触心率检测</strong><br>
                                    先进rPPG技术实现使用设备摄像头的实时心率测量 - 无需额外硬件。
                                </div>
                            </div>

                            <div class="education-feature">
                                <div class="feature-icon">👥</div>
                                <div>
                                    <strong>健康社交网络</strong><br>
                                    分享您的健康之旅，与朋友连接，参与支持性健康社区，让健身变得有趣且可持续。
                                </div>
                            </div>

                            <div class="education-feature">
                                <div class="feature-icon">🎨</div>
                                <div>
                                    <strong>Material You设计</strong><br>
                                    采用Material You设计原则的美观现代UI体验，兼顾科学准确性和卓越可用性。
                                </div>
                            </div>

                            <div class="education-feature">
                                <div class="feature-icon">🔮</div>
                                <div>
                                    <strong>未来计算机视觉</strong><br>
                                    我们持续开发先进CV方法，提供更全面的健康监测功能。
                                </div>
                            </div>

                            <p style="margin-top: 25px;"><strong>目标用户：</strong> RayVita非常适合想要使用尖端技术监测心血管健康，同时与支持性社区保持联系的年轻、关注健康的用户群体。</p>
                        </div>
                    </div>
                </div>

                <!-- Download App Panel -->
                <div class="panel" id="download">
                    <div class="panel-header">
                        <h1 class="panel-title">获取RayVita应用</h1>
                        <p class="panel-subtitle">下载RayVita移动应用，开始您的无接触健康监测之旅</p>
                    </div>

                    <div class="download-section">
                        <div class="download-title">🚀 RayVita移动应用</div>
                        <div class="download-subtitle">
                            体验健康监测的未来，搭载我们先进的rPPG技术。<br>
                            实时心率检测、AI洞察和社交健康功能 - 尽在您的口袋中。
                        </div>
                        <a href="#" class="download-btn" onclick="downloadAPK()">
                            <div class="download-icon">📱</div>
                            <div>
                                <div style="font-size: 14px; opacity: 0.8;">直接下载</div>
                                <div>RayVita.apk</div>
                            </div>
                        </a>
                    </div>

                    <div class="card-grid">
                        <div class="neural-card">
                            <div class="card-header">
                                <div>
                                    <h3 class="card-title">应用特色功能</h3>
                                    <div class="card-subtitle">RayVita的独特之处</div>
                                </div>
                                <div class="card-icon">✨</div>
                            </div>
                            <div class="education-feature">
                                <div class="feature-icon">📷</div>
                                <div>
                                    <strong>基于摄像头的监测</strong><br>
                                    将您的手机变成健康监测设备
                                </div>
                            </div>
                            <div class="education-feature">
                                <div class="feature-icon">🤖</div>
                                <div>
                                    <strong>AI健康洞察</strong><br>
                                    获得个性化健康建议
                                </div>
                            </div>
                            <div class="education-feature">
                                <div class="feature-icon">👨‍👩‍👧‍👦</div>
                                <div>
                                    <strong>社交健康网络</strong><br>
                                    与朋友和家人分享和比较
                                </div>
                            </div>
                        </div>

                        <div class="neural-card">
                            <div class="card-header">
                                <div>
                                    <h3 class="card-title">系统要求</h3>
                                    <div class="card-subtitle">设备兼容性</div>
                                </div>
                                <div class="card-icon">⚙️</div>
                            </div>
                            <div style="line-height: 1.8; color: var(--text-primary);">
                                <p><strong>Android设备:</strong></p>
                                <ul style="margin-left: 20px; margin-bottom: 15px;">
                                    <li>Android 8.0 (API级别26) 或更高版本</li>
                                    <li>需要前置摄像头</li>
                                    <li>建议最少3GB RAM</li>
                                    <li>支持ARMv7或ARM64架构</li>
                                </ul>
                                <p><strong>推荐配置:</strong></p>
                                <ul style="margin-left: 20px;">
                                    <li>Android 11.0 或更新版本</li>
                                    <li>4GB或更多RAM</li>
                                    <li>良好的前置摄像头质量</li>
                                    <li>稳定的网络连接</li>
                                </ul>
                            </div>
                        </div>

                        <div class="neural-card">
                            <div class="card-header">
                                <div>
                                    <h3 class="card-title">应用介绍</h3>
                                    <div class="card-subtitle">RayVita核心功能</div>
                                </div>
                                <div class="card-icon">📖</div>
                            </div>
                            <div style="line-height: 1.8; color: var(--text-primary);">
                                <p>RayVita是一款融合健康科技与社交互动的智能健康App。</p>

                                <div class="education-feature">
                                    <div class="feature-icon">💓</div>
                                    <div>
                                        <strong>rPPG无接触检测</strong><br>
                                        用户通过摄像头即可实时测量心率，无需佩戴任何设备
                                    </div>
                                </div>

                                <div class="education-feature">
                                    <div class="feature-icon">🌟</div>
                                    <div>
                                        <strong>健康社交系统</strong><br>
                                        支持动态发布、好友互动与健康数据分享，提升健康管理的趣味性
                                    </div>
                                </div>

                                <div class="education-feature">
                                    <div class="feature-icon">🎯</div>
                                    <div>
                                        <strong>高精度AI模型</strong><br>
                                        驱动的生理信号分析与Material You风格设计的现代化UI体验
                                    </div>
                                </div>

                                <p style="margin-top: 20px; color: var(--accent-green);">
                                    <strong>适合关注心率健康的年轻用户群体，兼顾科学性与可用性。</strong>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact Panel -->
                <div class="panel" id="contact">
                    <div class="panel-header">
                        <h1 class="panel-title">联系与支持</h1>
                        <p class="panel-subtitle">与我们的团队联系，获取支持、合作伙伴关系或一般咨询</p>
                    </div>

                    <div class="contact-grid">
                        <div class="contact-info">
                            <h3 style="color: var(--primary-cyan); margin-bottom: 25px; font-family: 'Orbitron', monospace;">联系我们</h3>

                            <div class="contact-item">
                                <div class="contact-icon">📧</div>
                                <div>
                                    <div style="font-weight: 600;">邮件支持</div>
                                    <div style="color: var(--text-secondary);">support@rayvita.com</div>
                                </div>
                            </div>

                            <div class="contact-item">
                                <div class="contact-icon">💼</div>
                                <div>
                                    <div style="font-weight: 600;">商务咨询</div>
                                    <div style="color: var(--text-secondary);">business@rayvita.com</div>
                                </div>
                            </div>

                            <div class="contact-item">
                                <div class="contact-icon">🔬</div>
                                <div>
                                    <div style="font-weight: 600;">研究合作</div>
                                    <div style="color: var(--text-secondary);">research@rayvita.com</div>
                                </div>
                            </div>

                            <div class="contact-item">
                                <div class="contact-icon">📱</div>
                                <div>
                                    <div style="font-weight: 600;">技术支持</div>
                                    <div style="color: var(--text-secondary);">+86 400-123-4567</div>
                                </div>
                            </div>

                            <div class="contact-item">
                                <div class="contact-icon">🏢</div>
                                <div>
                                    <div style="font-weight: 600;">公司地址</div>
                                    <div style="color: var(--text-secondary);">北京市海淀区中关村科技园</div>
                                </div>
                            </div>
                        </div>

                        <div class="map-container">
                            <div id="map"></div>
                        </div>
                    </div>

                    <div class="neural-card" style="margin-top: 40px;">
                        <div class="card-header">
                            <div>
                                <h3 class="card-title">公司信息</h3>
                                <div class="card-subtitle">关于RayVita科技</div>
                            </div>
                            <div class="card-icon">🏢</div>
                        </div>
                        <div style="line-height: 1.8; color: var(--text-primary);">
                            <p><strong>RayVita科技</strong>是无接触健康监测解决方案的领先创新者。我们由计算机视觉研究人员和医疗保健专业人士组成的团队创立，致力于通过尖端的rPPG技术让每个人都能获得先进的健康监测。</p>

                            <p style="margin-top: 20px;">我们的使命是通过消除对昂贵可穿戴设备或医疗设备的需求来实现健康监测的民主化，同时保持最高的准确性和可靠性标准。我们相信每个人都应该随时随地获得自己的健康数据。</p>

                            <div style="margin-top: 25px; padding: 20px; background: rgba(0, 255, 255, 0.05); border-radius: 10px; border-left: 3px solid var(--primary-cyan);">
                                <strong>🎯 我们的愿景：</strong> 创建一个健康监测就像看手机一样简单的世界，通过创新技术和社区支持，赋能个人掌控自己的心血管健康。
                            </div>

                            <div style="margin-top: 20px; padding: 20px; background: rgba(0, 255, 136, 0.05); border-radius: 10px; border-left: 3px solid var(--accent-green);">
                                <strong>🌟 RayVita-Synapse：</strong> 作为RayVita系列的网页端轻量化版本，定位为跨平台健康数据可视化与交互中枢，为用户提供全方位的健康管理体验。
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Advanced rPPG Record Viewer Modal -->
        <div class="record-viewer-modal" id="recordViewerModal">
            <div class="record-viewer-content">
                <div class="record-viewer-header">
                    <div>
                        <h3 style="color: var(--primary-cyan); font-family: 'Orbitron', monospace; font-size: 24px;">rPPG记录详细分析</h3>
                        <div style="color: var(--text-secondary); margin-top: 5px;" id="recordViewerSubtitle">会话详细信息和波形分析</div>
                    </div>
                    <div class="close-viewer" onclick="closeRecordViewer()">✕</div>
                </div>

                <div id="recordViewerDetails">
                    <!-- Record details will be populated here -->
                </div>

                <div class="waveform-controls">
                    <div class="waveform-btn active" data-type="rppg">rPPG信号</div>
                    <div class="waveform-btn" data-type="heartrate">心率趋势</div>
                    <div class="waveform-btn" data-type="hrv">HRV分析</div>
                    <div class="waveform-btn" data-type="quality">信号质量</div>
                    <div class="waveform-btn" data-type="fft">频谱分析</div>
                </div>

                <div class="waveform-container">
                    <canvas id="waveformChart"></canvas>
                </div>

                <div id="recordAnalysis" style="margin-top: 30px;">
                    <!-- Analysis will be populated here -->
                </div>
            </div>
        </div>

    </div>

    <script>
        // Global variables
        let currentUser = null;
        let healthData = [];
        let socialPosts = [];
        let chatMessages = [];
        let selectedRecord = null;
        let charts = {};
        let waveformChart = null;
        let map = null;
        let isLoggedIn = false;
        let isRegistering = false;

        // API Configuration
        const RAYVITA_BASE_URL = 'http://47.96.237.130:5000/api/';
        const DEEPSEEK_API_KEY = 'sk-0dd7411c6de74f119e9a06be144a89d6';
        const DEEPSEEK_BASE_URL = 'https://api.deepseek.com/';

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            checkAuthStatus();
            createStarField();
            initializeMap();
        });

        function createStarField() {
            const constellation = document.querySelector('.constellation');
            for (let i = 0; i < 20; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.top = Math.random() * 100 + '%';
                star.style.left = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                constellation.appendChild(star);
            }
        }

        function initializeMap() {
            // Initialize map when contact panel is first opened
            setTimeout(() => {
                if (!map) {
                    map = L.map('map').setView([39.9042, 116.4074], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: ' OpenStreetMap contributors'
                    }).addTo(map);

                    L.marker([39.9042, 116.4074]).addTo(map)
                        .bindPopup('<strong>RayVita科技总部</strong><br>北京市海淀区中关村科技园')
                        .openPopup();
                }
            }, 1000);
        }

        function setupEventListeners() {
            // Auth form submission
            document.getElementById('authForm').addEventListener('submit', handleAuth);

            // Toggle between login and register
            document.getElementById('toggleAuth').addEventListener('click', toggleAuthMode);

            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const panel = this.dataset.panel;
                    switchPanel(panel);
                });
            });

            // Chat input auto-resize
            const chatInput = document.getElementById('chatInput');
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            // Chat input enter to send
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Waveform controls
            document.querySelectorAll('.waveform-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.waveform-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    updateWaveform(this.dataset.type);
                });
            });
        }

        function checkAuthStatus() {
            // Check if user is already logged in (localStorage)
            const savedUser = localStorage.getItem('rayVitaUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainApp();
            }
        }

        async function handleAuth(e) {
            e.preventDefault();

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const nickname = document.getElementById('nickname').value;

            try {
                let response;
                if (isRegistering) {
                    response = await fetch(`${RAYVITA_BASE_URL}user/register`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ email, password, nickname })
                    });
                } else {
                    response = await fetch(`${RAYVITA_BASE_URL}user/login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ email, password })
                    });
                }

                const data = await response.json();

                if (response.ok) {
                    if (isRegistering) {
                        showMessage('神经档案创建成功！请登录以访问您的仪表板。', 'success');
                        toggleAuthMode();
                    } else {
                        // Get user details
                        const userResponse = await fetch(`${RAYVITA_BASE_URL}user/${data.user_id}`);
                        const userData = await userResponse.json();

                        currentUser = userData;
                        localStorage.setItem('rayVitaUser', JSON.stringify(currentUser));
                        showMainApp();
                    }
                } else {
                    showMessage(data.msg || '身份验证失败。请检查您的凭据。', 'error');
                }
                } catch (error) {
                console.error('Auth error:', error);
                showMessage('网络错误。请检查您的连接并重试。', 'error');
            }
        }

        function toggleAuthMode() {
            isRegistering = !isRegistering;
            const button = document.getElementById('authButton');
            const toggle = document.getElementById('toggleAuth');
            const nicknameGroup = document.getElementById('nicknameGroup');

            if (isRegistering) {
                button.textContent = '创建神经档案';
                toggle.innerHTML = '已有账户? <a href="#">接入神经网络</a>';
                nicknameGroup.style.display = 'block';
            } else {
                button.textContent = '接入神经网络';
                toggle.innerHTML = 'RayVita新用户? <a href="#">创建神经档案</a>';
                nicknameGroup.style.display = 'none';
            }

            // Clear form
            document.getElementById('authForm').reset();
            clearMessages();
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            isLoggedIn = true;

            // Update user info in header
            document.getElementById('userName').textContent = currentUser.nickname || currentUser.email;
            document.getElementById('userId').textContent = currentUser.user_id;
            document.getElementById('userAvatar').textContent = (currentUser.nickname || currentUser.email).charAt(0).toUpperCase();
            document.getElementById('composerAvatar').textContent = (currentUser.nickname || currentUser.email).charAt(0).toUpperCase();

            // Load initial data
            loadHealthData();
            loadSocialData();
            updateChatRecords();
        }

        function logout() {
            localStorage.removeItem('rayVitaUser');
            currentUser = null;
            isLoggedIn = false;

            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';

            // Clear form
            document.getElementById('authForm').reset();
            clearMessages();
        }

        function switchPanel(panelName) {
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-panel="${panelName}"]`).classList.add('active');

            // Show panel
            document.querySelectorAll('.panel').forEach(panel => {
                panel.classList.remove('active');
            });
            document.getElementById(panelName).classList.add('active');

            // Load panel-specific data
            if (panelName === 'social') {
                loadSocialData();
            } else if (panelName === 'records') {
                loadHealthData();
            } else if (panelName === 'ai-chat') {
                updateChatRecords();
            } else if (panelName === 'contact') {
                setTimeout(() => {
                    if (map) {
                        map.invalidateSize();
                    }
                }, 100);
            }
        }

        async function loadHealthData() {
            if (!currentUser) return;

            const loading = document.getElementById('loadingDashboard');
            if (loading) loading.style.display = 'block';

            try {
                const response = await fetch(`${RAYVITA_BASE_URL}health_measurements/user/${currentUser.user_id}`);
                if (response.ok) {
                    healthData = await response.json();
                    healthData.sort((a, b) => new Date(b.createdAt || b.timestamp) - new Date(a.createdAt || a.timestamp));
                    renderDashboard();
                    renderRecords();
                    updateChatRecords();
                    updateSocialStats();
                } else {
                    // Generate sample data for demo
                    generateSampleHealthData();
                }
            } catch (error) {
                console.error('Error loading health data:', error);
                generateSampleHealthData();
            } finally {
                if (loading) loading.style.display = 'none';
            }
        }

        function generateSampleHealthData() {
            // Generate realistic sample data for demonstration
            healthData = [];
            const now = new Date();

            for (let i = 0; i < 15; i++) {
                const date = new Date(now.getTime() - i * 3600000 * Math.random() * 24);
                const baseHR = 70 + Math.random() * 30;
                const confidence = 0.85 + Math.random() * 0.15;

                healthData.push({
                    sessionId: `demo-${i}`,
                    user_id: currentUser.user_id,
                    timestamp: date.getTime(),
                    createdAt: date.toISOString(),
                    heartRate: baseHR + (Math.random() - 0.5) * 10,
                    confidence: confidence,
                    frameCount: Math.floor(200 + Math.random() * 100),
                    processingTimeMs: Math.floor(1000 + Math.random() * 500),
                    hrvResult: {
                        rmssd: 20 + Math.random() * 40,
                        sdnn: 30 + Math.random() * 30,
                        pnn50: Math.random() * 20,
                        stressIndex: Math.random() * 0.8
                    },
                    spo2Result: {
                        spo2: 96 + Math.random() * 4
                    },
                    signalQuality: {
                        illuminationQuality: 0.7 + Math.random() * 0.3,
                        motionArtifact: Math.random() * 0.3
                    },
                    // Generate sample waveform data
                    rppgSignal: generateSampleWaveform(300, 'rppg'),
                    syncStatus: Math.random() > 0.5 ? 'synced' : 'pending'
                });
            }

            renderDashboard();
            renderRecords();
            updateChatRecords();
            updateSocialStats();
        }

        function generateSampleWaveform(length, type) {
            const data = [];
            const baseFreq = type === 'rppg' ? 0.02 : 0.01;

            for (let i = 0; i < length; i++) {
                let value = 0;

                if (type === 'rppg') {
                    value = Math.sin(i * baseFreq * 2 * Math.PI) * 0.8 +
                           Math.sin(i * baseFreq * 4 * Math.PI) * 0.3 +
                           (Math.random() - 0.5) * 0.2;
                } else if (type === 'heartrate') {
                    value = 70 + Math.sin(i * baseFreq * Math.PI) * 15 + (Math.random() - 0.5) * 5;
                } else if (type === 'quality') {
                    value = 0.8 + Math.sin(i * baseFreq * Math.PI) * 0.15 + (Math.random() - 0.5) * 0.1;
                }

                data.push(value);
            }

            return data;
        }

        function renderDashboard() {
            if (healthData.length === 0) {
                document.getElementById('vitalMetrics').innerHTML = '<p style="text-align: center; color: var(--text-secondary);">暂无健康数据。请使用RayVita应用开始测量。</p>';
                return;
            }

            // Render vital metrics
            renderVitalMetrics();
            renderRecentActivity();

            // Render charts
            setTimeout(() => {
                renderHeartRateChart();
                renderHRVChart();
                renderSpO2Chart();
                renderQualityChart();
            }, 100);
        }

        function renderVitalMetrics() {
            const latest = healthData[0];
            const previous = healthData[1] || latest;
            const container = document.getElementById('vitalMetrics');

            const heartRateTrend = latest.heartRate - (previous.heartRate || 0);
            const spo2Trend = latest.spo2Result ? latest.spo2Result.spo2 - (previous.spo2Result?.spo2 || 0) : 0;
            const confidenceTrend = latest.confidence - (previous.confidence || 0);

            container.innerHTML = `
                <div class="metric-item">
                    <div class="metric-value">${latest.heartRate ? latest.heartRate.toFixed(1) : '--'}</div>
                    <div class="metric-label">心率 (BPM)</div>
                    <div class="metric-trend ${heartRateTrend > 0 ? 'trend-up' : heartRateTrend < 0 ? 'trend-down' : 'trend-stable'}">
                        ${heartRateTrend > 0 ? '↗' : heartRateTrend < 0 ? '↘' : '→'} ${Math.abs(heartRateTrend).toFixed(1)}
                    </div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">${latest.spo2Result ? latest.spo2Result.spo2.toFixed(1) : '--'}</div>
                    <div class="metric-label">血氧 (%)</div>
                    <div class="metric-trend ${spo2Trend > 0 ? 'trend-up' : spo2Trend < 0 ? 'trend-down' : 'trend-stable'}">
                        ${spo2Trend > 0 ? '↗' : spo2Trend < 0 ? '↘' : '→'} ${Math.abs(spo2Trend).toFixed(1)}
                    </div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">${latest.hrvResult ? latest.hrvResult.rmssd.toFixed(1) : '--'}</div>
                    <div class="metric-label">RMSSD (ms)</div>
                    <div class="metric-trend trend-${latest.hrvResult && latest.hrvResult.rmssd > 30 ? 'up' : 'down'}">
                        ${latest.hrvResult && latest.hrvResult.rmssd > 30 ? '良好' : '关注'}
                    </div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">${latest.confidence ? (latest.confidence * 100).toFixed(0) : '--'}</div>
                    <div class="metric-label">置信度 (%)</div>
                    <div class="metric-trend ${confidenceTrend > 0 ? 'trend-up' : confidenceTrend < 0 ? 'trend-down' : 'trend-stable'}">
                        ${confidenceTrend > 0 ? '↗' : confidenceTrend < 0 ? '↘' : '→'} ${Math.abs(confidenceTrend * 100).toFixed(0)}%
                    </div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">${healthData.length}</div>
                    <div class="metric-label">总会话数</div>
                    <div class="metric-trend trend-up">
                        活跃
                    </div>
                </div>
                <div class="metric-item">
                    <div class="metric-value">${latest.hrvResult ? latest.hrvResult.stressIndex.toFixed(2) : '--'}</div>
                    <div class="metric-label">压力指数</div>
                    <div class="metric-trend trend-${latest.hrvResult && latest.hrvResult.stressIndex < 0.5 ? 'up' : 'down'}">
                        ${latest.hrvResult && latest.hrvResult.stressIndex < 0.5 ? '低' : '中等'}
                    </div>
                </div>
            `;
        }

        function renderRecentActivity() {
            const container = document.getElementById('recentActivity');
            const recentData = healthData.slice(0, 5);

            if (recentData.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">暂无最近活动</p>';
                return;
            }

            container.innerHTML = recentData.map(item => {
                const date = new Date(item.createdAt || item.timestamp);
                const timeAgo = getTimeAgo(date);

                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(0, 255, 255, 0.05); border-radius: 10px; margin-bottom: 10px; border-left: 3px solid var(--primary-cyan);">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 5px;">
                                心率: ${item.heartRate ? item.heartRate.toFixed(1) : 'N/A'} BPM
                                ${item.spo2Result ? `• 血氧: ${item.spo2Result.spo2.toFixed(1)}%` : ''}
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary);">
                                ${timeAgo} • 置信度: ${item.confidence ? (item.confidence * 100).toFixed(0) : 'N/A'}%
                            </div>
                        </div>
                        <div style="color: var(--accent-green); font-size: 18px;">💚</div>
                    </div>
                `;
            }).join('');
        }

        function renderRecords() {
            // Update statistics
            if (healthData.length > 0) {
                document.getElementById('totalSessions').textContent = healthData.length;
                document.getElementById('avgHeartRate').textContent = (healthData.reduce((sum, item) => sum + (item.heartRate || 0), 0) / healthData.length).toFixed(1);
                document.getElementById('avgConfidence').textContent = ((healthData.reduce((sum, item) => sum + (item.confidence || 0), 0) / healthData.length) * 100).toFixed(0) + '%';
                document.getElementById('lastMeasurement').textContent = getTimeAgo(new Date(healthData[0].createdAt || healthData[0].timestamp));
            }

            // Render records list
            const container = document.getElementById('recordsList');

            if (healthData.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">暂无rPPG测量记录。请使用RayVita应用查看您的数据。</p>';
                return;
            }

            container.innerHTML = healthData.map((item, index) => {
                const date = new Date(item.createdAt || item.timestamp);
                const qualityPercent = item.signalQuality ? Math.max(item.signalQuality.illuminationQuality * 100, 10) : 50;

                return `
                    <div class="record-item" onclick="openRecordViewer('${item.sessionId}')">
                        <div class="record-header">
                            <div class="record-id">会话 ${String(index + 1).padStart(3, '0')}</div>
                            <div class="record-time">${date.toLocaleString('zh-CN')}</div>
                        </div>

                        <div class="record-metrics">
                            <div class="record-metric">
                                <div class="record-metric-value">${item.heartRate ? item.heartRate.toFixed(1) : 'N/A'}</div>
                                <div class="record-metric-label">心率</div>
                            </div>
                            <div class="record-metric">
                                <div class="record-metric-value">${item.spo2Result ? item.spo2Result.spo2.toFixed(1) : 'N/A'}</div>
                                <div class="record-metric-label">血氧 (%)</div>
                            </div>
                            <div class="record-metric">
                                <div class="record-metric-value">${item.hrvResult ? item.hrvResult.rmssd.toFixed(1) : 'N/A'}</div>
                                <div class="record-metric-label">RMSSD</div>
                            </div>
                            <div class="record-metric">
                                <div class="record-metric-value">${item.confidence ? (item.confidence * 100).toFixed(0) : 'N/A'}</div>
                                <div class="record-metric-label">置信度</div>
                            </div>
                            <div class="record-metric">
                                <div class="record-metric-value">${item.frameCount || 'N/A'}</div>
                                <div class="record-metric-label">帧数</div>
                            </div>
                            <div class="record-metric">
                                <div class="record-metric-value">${item.processingTimeMs || 'N/A'}</div>
                                <div class="record-metric-label">处理时间(ms)</div>
                            </div>
                        </div>

                        <div class="record-quality">
                            <div class="quality-label">信号质量:</div>
                            <div class="quality-bar">
                                <div class="quality-fill" style="width: ${qualityPercent}%"></div>
                            </div>
                            <div class="quality-label">${qualityPercent.toFixed(0)}%</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderHeartRateChart() {
            const ctx = document.getElementById('heartRateChart')?.getContext('2d');
            if (!ctx || healthData.length === 0) return;

            if (charts.heartRate) {
                charts.heartRate.destroy();
            }

            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(0, 255, 255, 0.4)');
            gradient.addColorStop(1, 'rgba(0, 255, 255, 0.05)');

            charts.heartRate = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: healthData.slice().reverse().map(item => new Date(item.createdAt || item.timestamp).toLocaleTimeString('zh-CN')),
                    datasets: [{
                        label: '心率 (BPM)',
                        data: healthData.slice().reverse().map(item => item.heartRate),
                        borderColor: '#00ffff',
                        backgroundColor: gradient,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#00ffff',
                        pointBorderColor: '#ffffff',
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff',
                                font: { family: 'Inter', size: 14 }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#ffffff',
                                font: { family: 'Inter' }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: {
                                color: '#ffffff',
                                font: { family: 'Inter' }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }

        function renderHRVChart() {
            const ctx = document.getElementById('hrvChart')?.getContext('2d');
            if (!ctx) return;

            if (charts.hrv) {
                charts.hrv.destroy();
            }

            const validData = healthData.filter(item => item.hrvResult);
            if (validData.length === 0) {
                ctx.fillStyle = '#ffffff';
                ctx.font = '16px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('暂无HRV数据', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            charts.hrv = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['RMSSD', 'SDNN', 'pNN50', '压力指数'],
                    datasets: validData.slice(0, 3).map((item, index) => ({
                        label: `会话 ${index + 1}`,
                        data: [
                            Math.min(item.hrvResult.rmssd / 10, 100),
                            Math.min(item.hrvResult.sdnn / 5, 100),
                            item.hrvResult.pnn50 || 0,
                            Math.max(0, (1 - item.hrvResult.stressIndex) * 100)
                        ],
                        borderColor: ['#00ffff', '#0080ff', '#8000ff'][index],
                        backgroundColor: ['rgba(0, 255, 255, 0.1)', 'rgba(0, 128, 255, 0.1)', 'rgba(128, 0, 255, 0.1)'][index],
                        borderWidth: 3,
                        pointBackgroundColor: ['#00ffff', '#0080ff', '#8000ff'][index],
                        pointBorderColor: '#ffffff',
                        pointRadius: 4
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff',
                                font: { family: 'Inter', size: 14 }
                            }
                        }
                    },
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(255, 255, 255, 0.2)' },
                            grid: { color: 'rgba(255, 255, 255, 0.2)' },
                            pointLabels: {
                                color: '#ffffff',
                                font: { family: 'Inter', size: 12 }
                            },
                            ticks: {
                                color: '#ffffff',
                                backdropColor: 'transparent'
                            },
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    animation: {
                        duration: 2500,
                        easing: 'easeInOutElastic'
                    }
                }
            });
        }

        function renderSpO2Chart() {
            const ctx = document.getElementById('spo2Chart')?.getContext('2d');
            if (!ctx) return;

            if (charts.spo2) {
                charts.spo2.destroy();
            }

            const validData = healthData.filter(item => item.spo2Result);
            if (validData.length === 0) {
                ctx.fillStyle = '#ffffff';
                ctx.font = '16px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('暂无血氧数据', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(0, 255, 136, 0.3)');
            gradient.addColorStop(1, 'rgba(0, 255, 136, 0.05)');

            charts.spo2 = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: validData.slice().reverse().map(item => new Date(item.createdAt || item.timestamp).toLocaleTimeString('zh-CN')),
                    datasets: [{
                        label: '血氧饱和度 (%)',
                        data: validData.slice().reverse().map(item => item.spo2Result.spo2),
                        borderColor: '#00ff88',
                        backgroundColor: gradient,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#00ff88',
                        pointBorderColor: '#ffffff',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff',
                                font: { family: 'Inter', size: 14 }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#ffffff',
                                font: { family: 'Inter' }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: {
                                color: '#ffffff',
                                font: { family: 'Inter' }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            min: 95,
                            max: 100
                        }
                    }
                }
            });
        }

        function renderQualityChart() {
            const ctx = document.getElementById('qualityChart')?.getContext('2d');
            if (!ctx || healthData.length === 0) return;

            if (charts.quality) {
                charts.quality.destroy();
            }

            charts.quality = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: healthData.slice(0, 10).map((_, index) => `S${index + 1}`),
                    datasets: [{
                        label: '光照质量 (%)',
                        data: healthData.slice(0, 10).map(item => item.signalQuality ? item.signalQuality.illuminationQuality * 100 : 50),
                        backgroundColor: 'rgba(0, 255, 255, 0.7)',
                        borderColor: '#00ffff',
                        borderWidth: 2,
                        borderRadius: 6
                    }, {
                        label: '信号清晰度 (%)',
                        data: healthData.slice(0, 10).map(item => item.signalQuality ? (1 - (item.signalQuality.motionArtifact || 0)) * 100 : 80),
                        backgroundColor: 'rgba(255, 136, 0, 0.7)',
                        borderColor: '#ff8800',
                        borderWidth: 2,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff',
                                font: { family: 'Inter', size: 14 }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#ffffff',
                                font: { family: 'Inter' }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: {
                                color: '#ffffff',
                                font: { family: 'Inter' }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // Advanced Record Viewer Functions
        function openRecordViewer(sessionId) {
            const record = healthData.find(item => item.sessionId === sessionId);
            if (!record) return;

            selectedRecord = record;
            document.getElementById('recordViewerModal').style.display = 'flex';
            renderRecordDetails(record);
            updateWaveform('rppg');
        }

        function closeRecordViewer() {
            document.getElementById('recordViewerModal').style.display = 'none';
            selectedRecord = null;
            if (waveformChart) {
                waveformChart.destroy();
                waveformChart = null;
            }
        }

        function renderRecordDetails(record) {
            const date = new Date(record.createdAt || record.timestamp);
            const container = document.getElementById('recordViewerDetails');

            container.innerHTML = `
                <div class="card-grid dense" style="margin-bottom: 30px;">
                    <div class="neural-card">
                        <h4 style="color: var(--primary-cyan); margin-bottom: 20px;">📊 基本指标</h4>
                        <div class="metrics-grid">
                            <div class="metric-item">
                                <div class="metric-value">${record.heartRate ? record.heartRate.toFixed(1) : 'N/A'}</div>
                                <div class="metric-label">心率 (BPM)</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value">${record.confidence ? (record.confidence * 100).toFixed(0) : 'N/A'}</div>
                                <div class="metric-label">置信度 (%)</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value">${record.frameCount || 'N/A'}</div>
                                <div class="metric-label">帧数</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value">${record.processingTimeMs || 'N/A'}</div>
                                <div class="metric-label">处理时间</div>
                            </div>
                        </div>
                    </div>

                    <div class="neural-card">
                        <h4 style="color: var(--primary-cyan); margin-bottom: 20px;">💓 HRV分析</h4>
                        ${record.hrvResult ? `
                            <div class="metrics-grid">
                                <div class="metric-item">
                                    <div class="metric-value">${record.hrvResult.rmssd.toFixed(1)}</div>
                                    <div class="metric-label">RMSSD (ms)</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value">${record.hrvResult.sdnn.toFixed(1)}</div>
                                    <div class="metric-label">SDNN (ms)</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value">${record.hrvResult.pnn50 ? record.hrvResult.pnn50.toFixed(1) : 'N/A'}</div>
                                    <div class="metric-label">pNN50 (%)</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value">${record.hrvResult.stressIndex.toFixed(2)}</div>
                                    <div class="metric-label">压力指数</div>
                                </div>
                            </div>
                        ` : '<p style="text-align: center; color: var(--text-secondary);">暂无HRV数据</p>'}
                    </div>

                    <div class="neural-card">
                        <h4 style="color: var(--primary-cyan); margin-bottom: 20px;">🫁 血氧分析</h4>
                        ${record.spo2Result ? `
                            <div class="metrics-grid">
                                <div class="metric-item">
                                    <div class="metric-value">${record.spo2Result.spo2.toFixed(1)}</div>
                                    <div class="metric-label">血氧饱和度 (%)</div>
                                </div>
                                <div class="metric-item">
                                    <div class="metric-value">${record.spo2Result.spo2 >= 98 ? '优秀' : record.spo2Result.spo2 >= 96 ? '良好' : '关注'}</div>
                                    <div class="metric-label">健康状态</div>
                                </div>
                            </div>
                        ` : '<p style="text-align: center; color: var(--text-secondary);">暂无血氧数据</p>'}
                    </div>
                </div>

                <div class="neural-card">
                    <h4 style="color: var(--primary-cyan); margin-bottom: 20px;">📈 健康评估与建议</h4>
                    <div style="line-height: 1.8;">
                        ${generateHealthAssessment(record)}
                    </div>
                </div>
            `;
        }

        function generateHealthAssessment(record) {
            let assessment = '';

            // Heart Rate Assessment
            if (record.heartRate) {
                if (record.heartRate < 60) {
                    assessment += '<div class="education-feature"><div class="feature-icon" style="color: var(--accent-orange);">⚠️</div><div><strong>心率偏低：</strong>您的静息心率低于正常范围。如果您不是训练有素的运动员，建议咨询医生。</div></div>';
                } else if (record.heartRate > 100) {
                    assessment += '<div class="education-feature"><div class="feature-icon" style="color: var(--accent-pink);">🚨</div><div><strong>心率偏高：</strong>您的心率高于正常范围。可能是压力、咖啡因或其他因素导致的。建议休息并监测。</div></div>';
                } else {
                    assessment += '<div class="education-feature"><div class="feature-icon" style="color: var(--accent-green);">✅</div><div><strong>心率正常：</strong>您的心率在健康范围内（60-100 BPM）。</div></div>';
                }
            }

            // HRV Assessment
            if (record.hrvResult) {
                if (record.hrvResult.rmssd > 30) {
                    assessment += '<div class="education-feature"><div class="feature-icon" style="color: var(--accent-green);">💚</div><div><strong>HRV良好：</strong>RMSSD值表明您的自主神经系统平衡良好，压力管理能力较强。</div></div>';
                } else {
                    assessment += '<div class="education-feature"><div class="feature-icon" style="color: var(--accent-orange);">⚠️</div><div><strong>HRV需关注：</strong>RMSSD值偏低，可能表明压力较大或需要更多休息。建议进行放松练习。</div></div>';
                }

                if (record.hrvResult.stressIndex > 0.6) {
                    assessment += '<div class="education-feature"><div class="feature-icon" style="color: var(--accent-pink);">😰</div><div><strong>压力较大：</strong>压力指数较高，建议进行深呼吸、冥想或其他放松活动。</div></div>';
                }
            }

            // SpO2 Assessment
            if (record.spo2Result) {
                if (record.spo2Result.spo2 >= 98) {
                    assessment += '<div class="education-feature"><div class="feature-icon" style="color: var(--accent-green);">🫁</div><div><strong>血氧优秀：</strong>您的血氧饱和度在优秀范围内，呼吸系统和循环系统工作良好。</div></div>';
                } else if (record.spo2Result.spo2 >= 96) {
                    assessment += '<div class="education-feature"><div class="feature-icon" style="color: var(--accent-green);">👍</div><div><strong>血氧正常：</strong>您的血氧饱和度在正常范围内。</div></div>';
                } else {
                    assessment += '<div class="education-feature"><div class="feature-icon" style="color: var(--accent-orange);">⚠️</div><div><strong>血氧需关注：</strong>血氧饱和度稍低，如果持续如此，建议咨询医生。</div></div>';
                }
            }

            // Signal Quality Assessment
            if (record.signalQuality) {
                const quality = record.signalQuality.illuminationQuality;
                if (quality > 0.8) {
                    assessment += '<div class="education-feature"><div class="feature-icon" style="color: var(--accent-green);">📡</div><div><strong>信号质量优秀：</strong>测量环境和条件良好，数据可靠性高。</div></div>';
                } else if (quality > 0.6) {
                    assessment += '<div class="education-feature"><div class="feature-icon" style="color: var(--accent-orange);">📶</div><div><strong>信号质量一般：</strong>建议在光照充足、相对静止的环境下进行测量。</div></div>';
                } else {
                    assessment += '<div class="education-feature"><div class="feature-icon" style="color: var(--accent-pink);">📱</div><div><strong>信号质量需改善：</strong>建议改善光照条件，保持测量时的稳定性。</div></div>';
                }
            }

            // General Recommendations
            assessment += `
                <div style="margin-top: 25px; padding: 20px; background: rgba(0, 255, 255, 0.05); border-radius: 15px; border-left: 4px solid var(--primary-cyan);">
                    <h5 style="color: var(--primary-cyan); margin-bottom: 15px;">💡 个性化建议</h5>
                    <ul style="margin-left: 20px; line-height: 1.8;">
                        <li>保持规律的作息时间，确保充足睡眠（7-9小时）</li>
                        <li>进行适量有氧运动，如散步、游泳或骑行</li>
                        <li>学习压力管理技巧，如深呼吸、冥想或瑜伽</li>
                        <li>保持均衡饮食，适当控制咖啡因摄入</li>
                        <li>定期进行健康检查，监测心血管健康</li>
                    </ul>
                </div>
            `;

            return assessment;
        }

        function updateWaveform(type) {
            if (!selectedRecord) return;

            const ctx = document.getElementById('waveformChart').getContext('2d');

            if (waveformChart) {
                waveformChart.destroy();
            }

            let data = [];
            let label = '';
            let color = '#00ffff';
            let yAxisConfig = {};

            switch (type) {
                case 'rppg':
                    data = selectedRecord.rppgSignal || generateSampleWaveform(300, 'rppg');
                    label = 'rPPG信号强度';
                    color = '#00ffff';
                    yAxisConfig = { min: -1, max: 1 };
                    break;
                case 'heartrate':
                    data = generateSampleWaveform(100, 'heartrate');
                    label = '心率变化 (BPM)';
                    color = '#ff0080';
                    yAxisConfig = { min: 50, max: 120 };
                    break;
                case 'hrv':
                    if (selectedRecord.hrvResult) {
                        data = Array.from({length: 50}, (_, i) =>
                            selectedRecord.hrvResult.rmssd + Math.sin(i * 0.2) * 10 + (Math.random() - 0.5) * 5
                        );
                        label = 'HRV RMSSD (ms)';
                        color = '#8000ff';
                        yAxisConfig = { min: 0, max: 80 };
                    } else {
                        data = Array.from({length: 50}, () => 0);
                        label = 'HRV数据不可用';
                    }
                    break;
                case 'quality':
                    data = generateSampleWaveform(100, 'quality');
                    label = '信号质量指数';
                    color = '#00ff88';
                    yAxisConfig = { min: 0, max: 1 };
                    break;
                case 'fft':
                    data = Array.from({length: 50}, (_, i) => Math.exp(-i * 0.1) * (0.5 + Math.random() * 0.5));
                    label = 'FFT功率谱密度';
                    color = '#ffd700';
                    yAxisConfig = { min: 0, max: 1 };
                    break;
            }

            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, color + '40');
            gradient.addColorStop(1, color + '08');

            waveformChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map((_, i) => i),
                    datasets: [{
                        label: label,
                        data: data,
                        borderColor: color,
                        backgroundColor: gradient,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff',
                                font: { family: 'Inter', size: 14 }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#ffffff',
                                font: { family: 'Inter' }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            title: {
                                display: true,
                                text: '时间 / 采样点',
                                color: '#ffffff'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#ffffff',
                                font: { family: 'Inter' }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            title: {
                                display: true,
                                text: label,
                                color: '#ffffff'
                            },
                            ...yAxisConfig
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }

        // AI Chat Functions
        function updateChatRecords() {
            const container = document.getElementById('chatRecordsList');

            if (healthData.length === 0) {
                container.innerHTML = '<div class="record-item-chat" style="text-align: center; color: var(--text-secondary);">暂无记录可供分析</div>';
                return;
            }

            container.innerHTML = healthData.slice(0, 10).map((record, index) => {
                const date = new Date(record.createdAt || record.timestamp);
                return `
                    <div class="record-item-chat" onclick="selectRecordForChat('${record.sessionId}')">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 8px;">
                            <div style="font-weight: 600; color: var(--primary-cyan);">会话 ${String(index + 1).padStart(2, '0')}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">${date.toLocaleDateString('zh-CN')}</div>
                        </div>
                        <div style="font-size: 14px; color: var(--text-primary);">
                            心率: ${record.heartRate ? record.heartRate.toFixed(1) : 'N/A'} BPM
                            ${record.spo2Result ? ` • 血氧: ${record.spo2Result.spo2.toFixed(1)}%` : ''}
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                            置信度: ${record.confidence ? (record.confidence * 100).toFixed(0) : 'N/A'}%
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectRecordForChat(sessionId) {
            // Remove previous selection
            document.querySelectorAll('.record-item-chat').forEach(item => {
                item.classList.remove('selected');
            });

            // Add selection to clicked item
            event.target.closest('.record-item-chat').classList.add('selected');

            const record = healthData.find(item => item.sessionId === sessionId);
            if (record) {
                selectedRecord = record;

                // Add a message about the selected record
                const recordSummary = `已选择记录进行分析：\n• 测量时间: ${new Date(record.createdAt || record.timestamp).toLocaleString('zh-CN')}\n• 心率: ${record.heartRate ? record.heartRate.toFixed(1) : 'N/A'} BPM\n• 血氧: ${record.spo2Result ? record.spo2Result.spo2.toFixed(1) + '%' : 'N/A'}\n• 置信度: ${record.confidence ? (record.confidence * 100).toFixed(0) + '%' : 'N/A'}`;

                addChatMessage('ai', `📊 ${recordSummary}\n\n我已经分析了这条记录。您想了解什么特定方面呢？比如：\n• 心率是否正常？\n• HRV数据解读\n• 压力状态评估\n• 健康建议`);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            // Add user message
            addChatMessage('user', message);
            input.value = '';
            input.style.height = 'auto';

            // Show typing indicator
            const typingId = addChatMessage('ai', '正在思考...');

            try {
                // Prepare context for AI
                let context = `用户问题: ${message}\n\n`;

                if (selectedRecord) {
                    context += `当前分析的健康记录：\n`;
                    context += `- 测量时间: ${new Date(selectedRecord.createdAt || selectedRecord.timestamp).toLocaleString('zh-CN')}\n`;
                    context += `- 心率: ${selectedRecord.heartRate ? selectedRecord.heartRate.toFixed(1) + ' BPM' : '无数据'}\n`;
                    context += `- 血氧饱和度: ${selectedRecord.spo2Result ? selectedRecord.spo2Result.spo2.toFixed(1) + '%' : '无数据'}\n`;
                    context += `- 置信度: ${selectedRecord.confidence ? (selectedRecord.confidence * 100).toFixed(0) + '%' : '无数据'}\n`;

                    if (selectedRecord.hrvResult) {
                        context += `- HRV指标:\n`;
                        context += `  - RMSSD: ${selectedRecord.hrvResult.rmssd.toFixed(1)} ms\n`;
                        context += `  - SDNN: ${selectedRecord.hrvResult.sdnn.toFixed(1)} ms\n`;
                        context += `  - 压力指数: ${selectedRecord.hrvResult.stressIndex.toFixed(2)}\n`;
                    }
                }

                context += `\n用户历史记录概况：\n`;
                context += `- 总记录数: ${healthData.length}\n`;
                if (healthData.length > 0) {
                    const avgHR = healthData.reduce((sum, item) => sum + (item.heartRate || 0), 0) / healthData.length;
                    context += `- 平均心率: ${avgHR.toFixed(1)} BPM\n`;
                    const avgConf = healthData.reduce((sum, item) => sum + (item.confidence || 0), 0) / healthData.length;
                    context += `- 平均置信度: ${(avgConf * 100).toFixed(0)}%\n`;
                }

                const response = await fetch(`${DEEPSEEK_BASE_URL}v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${DEEPSEEK_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            {
                                role: 'system',
                                content: '你是RayVita的专业健康AI顾问，专门分析rPPG心率检测数据。请用中文回答，提供专业、准确、易理解的健康建议。重点关注心率、血氧、HRV等指标的解读和健康建议。保持回答简洁明了，适合普通用户理解。'
                            },
                            {
                                role: 'user',
                                content: context
                            }
                        ],
                        stream: false,
                        temperature: 0.7,
                        max_tokens: 1000
                    })
                });

                // Remove typing indicator
                removeChatMessage(typingId);

                if (response.ok) {
                    const data = await response.json();
                    const aiResponse = data.choices[0].message.content;
                    addChatMessage('ai', aiResponse);
                } else {
                    throw new Error(`AI请求失败: ${response.status}`);
                }

            } catch (error) {
                console.error('AI Chat error:', error);
                removeChatMessage(typingId);
                addChatMessage('ai', '抱歉，AI服务暂时不可用。请稍后重试。您可以查看仪表板中的健康指标或记录详情页面获取分析信息。');
            }
        }

        function addChatMessage(sender, content) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageId = 'msg-' + Date.now();

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.id = messageId;
            messageDiv.innerHTML = formatChatMessage(content);

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            return messageId;
        }

        function removeChatMessage(messageId) {
            const message = document.getElementById(messageId);
            if (message) {
                message.remove();
            }
        }

        function formatChatMessage(content) {
            return content
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/•/g, '•');
        }

        // AI Analysis Functions
        async function performAIAnalysis() {
            if (!currentUser || healthData.length === 0) {
                showMessage('暂无健康数据进行AI分析。请确保您有rPPG测量记录。', 'error');
                return;
            }

            const container = document.getElementById('aiAnalysisContent');
            container.innerHTML = `
                <div style="border: 2px solid var(--primary-purple); background: rgba(128, 0, 255, 0.05); padding: 40px; border-radius: 20px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 20px;">🧠</div>
                    <h4 style="color: var(--primary-purple); margin-bottom: 15px; font-family: 'Orbitron', monospace;">DeepSeek神经分析中</h4>
                    <div class="loading">
                        <div class="spinner"></div>
                        <div>AI正在分析您的健康模式...</div>
                    </div>
                </div>
            `;

            try {
                // Prepare comprehensive health data summary for AI analysis
                const latestData = healthData.slice(0, 10);
                const summary = {
                    userProfile: {
                        userId: currentUser.user_id,
                        totalSessions: healthData.length,
                        analysisDate: new Date().toISOString()
                    },
                    recentMeasurements: latestData.map(item => ({
                        timestamp: item.createdAt || item.timestamp,
                        heartRate: item.heartRate,
                        spo2: item.spo2Result?.spo2,
                        hrvMetrics: item.hrvResult ? {
                            rmssd: item.hrvResult.rmssd,
                            sdnn: item.hrvResult.sdnn,
                            pnn50: item.hrvResult.pnn50,
                            stressIndex: item.hrvResult.stressIndex
                        } : null,
                        confidence: item.confidence,
                        signalQuality: item.signalQuality
                    })),
                    statisticalSummary: {
                        heartRate: {
                            average: healthData.reduce((sum, item) => sum + (item.heartRate || 0), 0) / healthData.length,
                            min: Math.min(...healthData.map(item => item.heartRate || 0)),
                            max: Math.max(...healthData.map(item => item.heartRate || 0))
                        },
                        spo2: healthData.filter(item => item.spo2Result).length > 0 ? {
                            average: healthData.filter(item => item.spo2Result).reduce((sum, item) => sum + item.spo2Result.spo2, 0) / healthData.filter(item => item.spo2Result).length,
                            min: Math.min(...healthData.filter(item => item.spo2Result).map(item => item.spo2Result.spo2)),
                            max: Math.max(...healthData.filter(item => item.spo2Result).map(item => item.spo2Result.spo2))
                        } : null,
                        hrv: healthData.filter(item => item.hrvResult).length > 0 ? {
                            averageRMSSD: healthData.filter(item => item.hrvResult).reduce((sum, item) => sum + item.hrvResult.rmssd, 0) / healthData.filter(item => item.hrvResult).length,
                            averageStress: healthData.filter(item => item.hrvResult).reduce((sum, item) => sum + item.hrvResult.stressIndex, 0) / healthData.filter(item => item.hrvResult).length
                        } : null
                    }
                };

                const prompt = `作为专业的健康分析AI，请分析以下完整的生物测量数据集：

${JSON.stringify(summary, null, 2)}

请提供详细的健康分析，包括：

🔍 **整体评估**
- 心血管健康状态总览
- 识别的关键趋势和模式
- 数据质量和可靠性评估

⚠️ **健康洞察**
- 心率变异性分析
- 压力水平指标
- 血氧饱和度模式
- 任何需要关注的趋势或异常

💡 **个性化建议**
- 生活方式改善建议
- 监测频率建议
- 需要医疗关注的领域（如有）
- 健康优化策略

📊 **技术分析**
- rPPG信号质量评估
- 测量准确性评估
- 数据收集改进建议

🎯 **行动计划**
- 立即改善健康的步骤
- 长期监测目标
- 何时咨询医疗专业人士

请用中文格式化回答，提供清晰的章节和可操作的洞察。专注于信息丰富、支持性和科学准确，同时保持用户易于理解。`;

                const response = await fetch(`${DEEPSEEK_BASE_URL}v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${DEEPSEEK_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            {
                                role: 'system',
                                content: '你是专门从事心血管监测、rPPG技术和生物测量数据解读的专业AI健康分析师。提供全面、准确和可操作的健康洞察。用中文回答。'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        stream: false,
                        temperature: 0.7,
                        max_tokens: 2000
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const analysis = data.choices[0].message.content;

                    // Format and display the AI response
                    const formattedAnalysis = formatAIAnalysis(analysis);

                    container.innerHTML = `
                        <div style="border: 2px solid var(--primary-purple); background: rgba(128, 0, 255, 0.05); padding: 40px; border-radius: 20px;">
                            <div style="text-align: center; margin-bottom: 30px;">
                                <div style="font-size: 48px; margin-bottom: 15px;">🧠</div>
                                <h4 style="color: var(--primary-purple); margin-bottom: 10px; font-family: 'Orbitron', monospace;">DeepSeek神经分析完成</h4>
                                <div style="color: var(--text-secondary);">基于 ${healthData.length} 项测量记录的分析</div>
                            </div>
                            <div style="line-height: 1.8; color: var(--text-primary);">
                                ${formattedAnalysis}
                            </div>
                        </div>
                    `;
                } else {
                    throw new Error(`AI分析失败: ${response.status}`);
                }
            } catch (error) {
                console.error('AI analysis error:', error);
                container.innerHTML = `
                    <div style="border: 2px dashed rgba(255, 0, 128, 0.3); text-align: center; padding: 40px; border-radius: 20px; background: rgba(255, 0, 128, 0.02);">
                        <div style="font-size: 48px; margin-bottom: 20px;">❌</div>
                        <h4 style="color: var(--accent-pink); margin-bottom: 15px; font-family: 'Orbitron', monospace;">分析暂时不可用</h4>
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">AI服务暂时不可用。这可能是由于网络连接或服务限制造成的。请稍后重试。</p>
                        <div style="background: rgba(0, 255, 255, 0.05); padding: 20px; border-radius: 10px; border-left: 3px solid var(--primary-cyan);">
                            <strong>替代方案：</strong> 您仍然可以在仪表板和记录部分查看您的健康指标，以手动分析您的rPPG测量结果。
                        </div>
                    </div>
                `;
            }
        }

        function formatAIAnalysis(analysis) {
            // Convert markdown-style formatting to HTML
            let formatted = analysis
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/#{1,6}\s*(.*?)$/gm, '<h4 style="color: var(--primary-cyan); margin: 25px 0 15px 0; font-family: \'Orbitron\', monospace; font-size: 18px;">$1</h4>')
                .replace(/^- (.*?)$/gm, '<div style="margin: 10px 0; padding: 15px; background: rgba(0, 255, 255, 0.05); border-radius: 10px; border-left: 3px solid var(--primary-cyan);">• $1</div>')
                .replace(/(\d+\.)\s*(.*?)$/gm, '<div style="margin: 10px 0; padding: 15px; background: rgba(0, 255, 255, 0.05); border-radius: 10px;"><strong>$1</strong> $2</div>');

            // Add special formatting for sections
            formatted = formatted
                .replace(/🔍\s*\*\*整体评估\*\*/g, '<h4 style="color: var(--primary-cyan); margin: 25px 0 15px 0; font-family: \'Orbitron\', monospace;">🔍 整体评估</h4>')
                .replace(/⚠️\s*\*\*健康洞察\*\*/g, '<h4 style="color: var(--accent-orange); margin: 25px 0 15px 0; font-family: \'Orbitron\', monospace;">⚠️ 健康洞察</h4>')
                .replace(/💡\s*\*\*个性化建议\*\*/g, '<h4 style="color: var(--accent-green); margin: 25px 0 15px 0; font-family: \'Orbitron\', monospace;">💡 个性化建议</h4>')
                .replace(/📊\s*\*\*技术分析\*\*/g, '<h4 style="color: var(--primary-blue); margin: 25px 0 15px 0; font-family: \'Orbitron\', monospace;">📊 技术分析</h4>')
                .replace(/🎯\s*\*\*行动计划\*\*/g, '<h4 style="color: var(--accent-pink); margin: 25px 0 15px 0; font-family: \'Orbitron\', monospace;">🎯 行动计划</h4>');

            return formatted;
        }

        // Social Functions
        async function loadSocialData() {
            if (!currentUser) return;

            try {
                // Load social feed
                const feedResponse = await fetch(`${RAYVITA_BASE_URL}post/feed?user_id=${currentUser.user_id}&scope=all`);
                if (feedResponse.ok) {
                    socialPosts = await feedResponse.json();
                } else {
                    // Generate sample social data for demo
                    generateSampleSocialData();
                }

                renderSocialFeed(socialPosts);

                // Load friends network
                const friendsResponse = await fetch(`${RAYVITA_BASE_URL}friend/list?user_id=${currentUser.user_id}`);
                if (friendsResponse.ok) {
                    const friendsData = await friendsResponse.json();
                    renderFriendsNetwork(friendsData);
                } else {
                    renderFriendsNetwork([]);
                }

            } catch (error) {
                console.error('Error loading social data:', error);
                generateSampleSocialData();
                renderSocialFeed(socialPosts);
                renderFriendsNetwork([]);
            }
        }

        function generateSampleSocialData() {
            socialPosts = [
                {
                    post_id: 1,
                    user_id: 101,
                    post_dt: new Date(Date.now() - 3600000).toISOString(),
                    text_content: "今天的心率检测结果很不错！静息心率68 BPM，感觉身体状态很好 💪 #健康生活 #rPPG技术",
                    like_count: 12,
                    comment_count: 3,
                    user_liked: false
                },
                {
                    post_id: 2,
                    user_id: 102,
                    post_dt: new Date(Date.now() - 7200000).toISOString(),
                    text_content: "刚刚完成了10分钟的冥想，HRV指标明显改善！压力管理真的很重要 🧘‍♀️",
                    like_count: 8,
                    comment_count: 2,
                    user_liked: true
                },
                {
                    post_id: 3,
                    user_id: 103,
                    post_dt: new Date(Date.now() - 14400000).toISOString(),
                    text_content: "使用RayVita已经一个月了，心率数据显示我的心血管健康在逐步改善！感谢这个神奇的应用 ❤️",
                    like_count: 25,
                    comment_count: 8,
                    user_liked: false
                }
            ];
        }

        function renderSocialFeed(posts) {
            const container = document.getElementById('socialFeed');

            if (posts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); padding: 60px; background: rgba(0, 255, 255, 0.02); border-radius: 20px; border: 1px dashed rgba(0, 255, 255, 0.2);">
                        <div style="font-size: 64px; margin-bottom: 20px;">💬</div>
                        <div style="font-size: 20px; font-weight: 600; margin-bottom: 15px;">暂无动态</div>
                        <div style="font-size: 16px;">成为第一个分享健康心得的人！</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = posts.map(post => {
                const date = new Date(post.post_dt);
                const timeAgo = getTimeAgo(date);
                const userInitial = `用户${post.user_id}`.charAt(0).toUpperCase();

                return `
                    <div class="post-item">
                        <div class="post-header">
                            <div class="post-avatar">${userInitial}</div>
                            <div class="post-meta">
                                <div class="post-author">用户${post.user_id}</div>
                                <div class="post-time">${timeAgo}</div>
                            </div>
                        </div>
                        <div class="post-content">${post.text_content || '分享了一条健康动态'}</div>
                        <div class="post-actions">
                            <button class="action-btn btn-like ${post.user_liked ? 'liked' : ''}" onclick="toggleLike(${post.post_id})">
                                💖 ${post.like_count || 0}
                            </button>
                            <button class="action-btn btn-comment">
                                💬 ${post.comment_count || 0}
                            </button>
                            <button class="action-btn btn-share">
                                🔄 分享
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderFriendsNetwork(friends) {
            const container = document.getElementById('friendsNetwork');

            if (friends.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); padding: 30px;">
                        <div style="font-size: 32px; margin-bottom: 10px;">👥</div>
                        <div style="font-size: 14px;">暂无健康网络连接</div>
                        <div style="font-size: 12px; margin-top: 5px;">开始建立您的健康社区！</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = friends.slice(0, 5).map(friend => `
                <div style="display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid rgba(0, 255, 255, 0.1);">
                    <div style="width: 32px; height: 32px; background: linear-gradient(45deg, var(--accent-green), var(--primary-blue)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 600; font-size: 14px;">
                        ${(friend.nickname || `用户${friend.user_id}`).charAt(0).toUpperCase()}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 14px;">${friend.nickname || `用户${friend.user_id}`}</div>
                        <div style="font-size: 12px; color: var(--accent-green);">在线</div>
                    </div>
                </div>
            `).join('');
        }

        function updateSocialStats() {
            // Update social statistics
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const todayMeasurements = healthData.filter(item => {
                const itemDate = new Date(item.createdAt || item.timestamp);
                return itemDate >= today;
            }).length;

            document.getElementById('todayMeasurements').textContent = todayMeasurements;

            if (healthData.length > 0) {
                const weeklyData = healthData.filter(item => {
                    const itemDate = new Date(item.createdAt || item.timestamp);
                    const weekAgo = new Date(Date.now() - 7 * 24 * 3600 * 1000);
                    return itemDate >= weekAgo;
                });

                if (weeklyData.length > 0) {
                    const avgHR = weeklyData.reduce((sum, item) => sum + (item.heartRate || 0), 0) / weeklyData.length;
                    document.getElementById('weeklyAvgHR').textContent = avgHR.toFixed(1);
                }

                // Calculate health score
                const latest = healthData[0];
                let healthScore = 85; // Base score

                if (latest.heartRate && latest.heartRate >= 60 && latest.heartRate <= 100) {
                    healthScore += 5;
                }
                if (latest.spo2Result && latest.spo2Result.spo2 >= 98) {
                    healthScore += 5;
                }
                if (latest.hrvResult && latest.hrvResult.stressIndex < 0.5) {
                    healthScore += 5;
                }

                document.getElementById('healthScore').textContent = Math.min(healthScore, 100);
            }
        }

        async function createPost() {
            const textContent = document.getElementById('postText').value.trim();
            if (!textContent || !currentUser) return;

            try {
                const response = await fetch(`${RAYVITA_BASE_URL}post/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentUser.user_id,
                        text_content: textContent,
                        post_type: 'health_update'
                    })
                });

                if (response.ok) {
                    document.getElementById('postText').value = '';
                    showMessage('健康动态发布成功！🎉', 'success');
                    loadSocialData(); // Refresh the feed
                } else {
                    const data = await response.json();
                    showMessage(data.msg || '发布失败', 'error');
                }
            } catch (error) {
                console.error('Error creating post:', error);
                // Add post locally for demo
                const newPost = {
                    post_id: Date.now(),
                    user_id: currentUser.user_id,
                    post_dt: new Date().toISOString(),
                    text_content: textContent,
                    like_count: 0,
                    comment_count: 0,
                    user_liked: false
                };
                socialPosts.unshift(newPost);
                renderSocialFeed(socialPosts);
                document.getElementById('postText').value = '';
                showMessage('健康动态发布成功！🎉', 'success');
            }
        }

        async function toggleLike(postId) {
            if (!currentUser) return;

            try {
                const response = await fetch(`${RAYVITA_BASE_URL}post/${postId}/like`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentUser.user_id
                    })
                });

                if (response.ok) {
                    loadSocialData(); // Refresh to update like counts
                } else {
                    // Handle locally for demo
                    const post = socialPosts.find(p => p.post_id === postId);
                    if (post) {
                        if (post.user_liked) {
                            post.like_count--;
                            post.user_liked = false;
                        } else {
                            post.like_count++;
                            post.user_liked = true;
                        }
                        renderSocialFeed(socialPosts);
                    }
                }
            } catch (error) {
                console.error('Error toggling like:', error);
                // Handle locally for demo
                const post = socialPosts.find(p => p.post_id === postId);
                if (post) {
                    if (post.user_liked) {
                        post.like_count--;
                        post.user_liked = false;
                    } else {
                        post.like_count++;
                        post.user_liked = true;
                    }
                    renderSocialFeed(socialPosts);
                }
            }
        }

        // Download Functions
        function downloadAPK() {
            showMessage('正在准备下载RayVita.apk...', 'success');

            // Simulate APK download
            setTimeout(() => {
                const link = document.createElement('a');
                link.href = '#'; // In real implementation, this would be the actual APK URL
                link.download = 'RayVita.apk';

                showMessage('APK文件将很快发布！📱 请关注我们的更新通知。', 'success');

                // In a real implementation, you would trigger the actual download
                // document.body.appendChild(link);
                // link.click();
                // document.body.removeChild(link);
            }, 1500);
        }

        // Utility Functions
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffDays > 0) return `${diffDays}天前`;
            if (diffHours > 0) return `${diffHours}小时前`;
            if (diffMins > 0) return `${diffMins}分钟前`;
            return '刚刚';
        }

        function showMessage(message, type) {
            // Create floating notification
            const notification = document.createElement('div');
            notification.className = `${type}-message`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                padding: 15px 25px;
                border-radius: 10px;
                font-weight: 600;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                animation: slideIn 0.3s ease-out;
                max-width: 400px;
            `;

            const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️';
            notification.innerHTML = `${icon} ${message}`;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in forwards';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 4000);

            // Also update auth message container if exists
            const container = document.getElementById('authMessage');
            if (container) {
                container.innerHTML = `<div class="${type}-message">${icon} ${message}</div>`;
                setTimeout(() => {
                    container.innerHTML = '';
                }, 5000);
            }
        }

        function clearMessages() {
            const container = document.getElementById('authMessage');
            if (container) {
                container.innerHTML = '';
            }
        }

        // Add CSS animations for notifications
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Auto-refresh health data every 5 minutes
        setInterval(() => {
            if (currentUser && isLoggedIn) {
                loadHealthData();
            }
        }, 5 * 60 * 1000);

        // Auto-refresh social data every 2 minutes
        setInterval(() => {
            if (currentUser && isLoggedIn) {
                loadSocialData();
            }
        }, 2 * 60 * 1000);

        // Click outside to close record viewer
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('recordViewerModal');
            if (e.target === modal) {
                closeRecordViewer();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Escape to close modals
            if (e.key === 'Escape') {
                closeRecordViewer();
            }
        });
    </script>
</body>
</html>